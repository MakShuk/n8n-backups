# n8n Backup

Этот проект предназначен для резервного копирования данных n8n. В проекте используются Docker Compose для создания необходимых сервисов, WebDAV для хранения резервных копий в облаке и скрипты для автоматизации задач по бэкапу и настройке.

## Структура проекта

- **.gitignore** - файлы и каталоги, исключенные из контроля версий.
- **docker-compose.yml** - конфигурация Docker Compose для запуска необходимых сервисов.
- **backup/** - каталог для хранения резервных копий.
- **config/** - каталог для хранения конфигурационных файлов.
- **scripts/** - каталог со скриптами:
  - **backup.sh** - скрипт для создания резервных копий.
  - **setup.sh** - скрипт для первоначальной настройки проекта.
- **.env** - файл с настройками окружения.

## Пример шаблона .env

Создайте файл `.env` в корневом каталоге проекта и заполните его следующими переменными:

```
WEBDAV_URL=https://webdav.cloud.mail.ru
WEBDAV_USERNAME=user@bk.ru
WEBDAV_PASSWORD=pass
BACKUP_KEEP_DAYS=1
CLOUD_KEEP_DAYS=30
N8N_DATA_FOLDER=C:\User\.n8n
ARCHIVE_PASSWORD=pass
```

### Описание переменных

| Переменная | Описание | Значение по умолчанию |
|------------|----------|----------------------|
| `WEBDAV_URL` | URL WebDAV сервера | - |
| `WEBDAV_USERNAME` | Имя пользователя WebDAV | - |
| `WEBDAV_PASSWORD` | Пароль WebDAV | - |
| `BACKUP_KEEP_DAYS` | Срок хранения локальных бэкапов (дни) | 1 |
| `CLOUD_KEEP_DAYS` | Срок хранения бэкапов в облаке (дни) | 30 |
| `N8N_DATA_FOLDER` | Путь к папке данных n8n | - |
| `ARCHIVE_PASSWORD` | Пароль для шифрования архивов | - |

## Последовательность выполнения резервного копирования (скрипт backup.sh)

1. **Установка переменных**: Скрипт устанавливает дату резервного копирования, пути для хранения архива и данных, а также значения для периодов хранения архивов (локально и в облаке).
2. **Проверка конфигурации rclone**: Если файл конфигурации rclone отсутствует, скрипт автоматически создает его с помощью команды `rclone config create` и выводит текущую конфигурацию.
3. **Создание локального архива**: Данные из указанного каталога архивируются с использованием команды `tar`, и архив сохраняется в указанном каталоге.
4. **Копирование архива на облачное хранилище**: Архив копируется на удаленное облачное хранилище через `rclone copy`. При неудаче выполняется повторная попытка с явным указанием конфигурационного файла.
5. **Проверка успешности загрузки**: Скрипт проверяет, доступен ли загруженный архив в облачном хранилище с помощью `rclone ls`.
6. **Ротация бэкапов в облаке**: Удаляются архивы старше `CLOUD_KEEP_DAYS` дней из облачного хранилища.
7. **Ротация локальных бэкапов**: Удаляются локальные архивы старше `BACKUP_KEEP_DAYS` дней.
8. **Отчёт о состоянии**: Выводится информация о текущем состоянии локального и облачного хранилищ.
## Шифрование резервных копий
Для защиты данных резервные копии шифруются с использованием алгоритма AES-256. Шифрование осуществляется перед упаковкой архива, что гарантирует, что данные будут защищены даже при утечке физических файлов. Для расшифровки архивов используется ключ, указанный в переменной окружения ARCHIVE_PASSWORD. Убедитесь, что данное значение хранится в безопасном месте и не попадает в публичный доступ.

Для расшифровки архива выполните команду:
```
openssl enc -d -aes-256-cbc -salt -pbkdf2 -in n8n-backup-2025-03-11_13-01-52.tar.gz.enc -out n8n-backup-2025-03-11_13-01-52_decrypted.tar.gz -pass pass:"pass"
```

## Требования

- Docker и Docker Compose должны быть установлены на системе.
- Git для клонирования репозитория.

## Установка и запуск

1. Клонируйте репозиторий:
```
git clone <URL-репозитория>
```
2. Перейдите в каталог проекта:
```
cd n8n-backup
```
3. Запустите Docker Compose:
```
docker-compose up -d
```

## Лицензия

Проект распространяется под лицензией MIT.
